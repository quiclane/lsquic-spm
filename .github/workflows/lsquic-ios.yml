name: lsquic-ios
on:
  workflow_dispatch:
  schedule:
    - cron: "47 5 * * *"
permissions:
  contents: write
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install deps
        run: |
          set -euo pipefail
          sudo softwareupdate --install-rosetta --agree-to-license || true
          brew update
          brew install cmake ninja unzip || true
          command -v gh >/dev/null 2>&1 || brew install gh || true
      - name: Gate
        id: gate
        run: |
          set -euo pipefail
          ROOT="$PWD"
          CFG="$ROOT/ci/lsquic-upstream.txt"
          REPO="$(awk -F= '/^repo=/{print $2}' "$CFG" 2>/dev/null|tail -n 1)"
          BRANCH="$(awk -F= '/^branch=/{print $2}' "$CFG" 2>/dev/null|tail -n 1)"
          [ -n "${REPO:-}" ]||REPO="https://github.com/litespeedtech/lsquic.git"
          [ -n "${BRANCH:-}" ]||BRANCH="master"
          LAST_FILE="$ROOT/ci/last_success_epoch.txt"
          UP_FILE="$ROOT/ci/upstream_head.txt"
          now="$(date +%s)"
          last=0
          if [ -f "$LAST_FILE" ]; then last="$(tr -d '\r\n ' <"$LAST_FILE"||echo 0)"; fi
          if [ -n "${last:-}" ] && [ "$last" -gt 0 ] 2>/dev/null; then age="$((now-last))"; else age=999999999; fi
          tmp="$(mktemp -d)"
          git clone --depth 1 --branch "$BRANCH" "$REPO" "$tmp/up"
          head="$(git -C "$tmp/up" rev-parse HEAD)"
          rm -rf "$tmp"
          prev=""
          if [ -f "$UP_FILE" ]; then prev="$(tr -d '\r\n ' <"$UP_FILE"||true)"; fi
          should=1
          if [ "$age" -lt 302400 ]; then should=0; fi
          if [ -n "${prev:-}" ] && [ "$head" = "$prev" ]; then should=0; fi
          echo "head=$head" >> "$GITHUB_OUTPUT"
          echo "now=$now" >> "$GITHUB_OUTPUT"
          echo "should=$should" >> "$GITHUB_OUTPUT"
      - name: Fetch latest BoringSSL xcframework
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/_boringssl"
          api="https://api.github.com/repos/quiclane/boringssl-spm/releases/latest"
          json="$(curl -fsSL "$api")"
          url="$(printf "%s" "$json" | python3 -c 'import json,sys; j=json.load(sys.stdin); a=j.get("assets",[]); z=[x for x in a if x.get("name","").endswith(".xcframework.zip")]; print(z[0]["browser_download_url"] if z else "")')"
          test -n "$url"
          curl -fL -o "$GITHUB_WORKSPACE/_boringssl/BoringSSL.xcframework.zip" "$url"
          unzip -q "$GITHUB_WORKSPACE/_boringssl/BoringSSL.xcframework.zip" -d "$GITHUB_WORKSPACE/_boringssl"
          test -d "$GITHUB_WORKSPACE/_boringssl/BoringSSL.xcframework"
      - name: Build
        if: steps.gate.outputs.should == '1'
        env:
          BORING_XCF: ${{ github.workspace }}/_boringssl/BoringSSL.xcframework
        run: |
          set -euo pipefail
          chmod +x ci/build_lsquic_ios.sh
          ./ci/build_lsquic_ios.sh
      - name: Verify outputs
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          test -f build-out/LSQUIC.xcframework.zip
          test -d build-out/LSQUIC.xcframework
      - name: Stage repo-root artifacts
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          rm -rf LSQUIC.xcframework LSQUIC.xcframework.zip liblsquic.a
          cp -R build-out/LSQUIC.xcframework ./LSQUIC.xcframework
          cp build-out/LSQUIC.xcframework.zip ./LSQUIC.xcframework.zip
          cp ./LSQUIC.xcframework/ios-arm64/liblsquic.a ./liblsquic.a
      - name: Update state files
        if: steps.gate.outputs.should == '1'
        run: |
          set -euo pipefail
          mkdir -p ci
          printf "%s\n" "${{ steps.gate.outputs.head }}" > ci/upstream_head.txt
          printf "%s\n" "${{ steps.gate.outputs.now }}" > ci/last_success_epoch.txt
      - name: Commit artifacts + bump tag
        if: steps.gate.outputs.should == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "repo: update LSQUIC artifacts" || true
          git fetch --tags origin
          last="$(git tag -l '1.0.*' | sort -V | tail -n1)"
          if [ -z "${last:-}" ]; then next="1.0.0"; else p="${last##1.0.}"; p="${p:-0}"; next="1.0.$((p+1))"; fi
          git tag "$next" || true
          git push origin main
          git push origin "$next"
      - name: Compute checksum + notes
        if: steps.gate.outputs.should == '1'
        id: sum
        run: |
          set -euo pipefail
          cs="$(swift package compute-checksum build-out/LSQUIC.xcframework.zip)"
          echo "checksum=$cs" >> "$GITHUB_OUTPUT"
          printf "upstream=%s\nchecksum=%s\n" "${{ steps.gate.outputs.head }}" "$cs" > /tmp/release-notes.txt
      - name: Publish release
        if: steps.gate.outputs.should == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          short="$(echo "${{ steps.gate.outputs.head }}" | cut -c1-12)"
          tag="ios-$(date +%Y%m%d)-${short}"
          gh release create "$tag" build-out/LSQUIC.xcframework.zip --title "$tag" --notes-file /tmp/release-notes.txt
      - name: Prune old releases (keep 2 newest)
        if: steps.gate.outputs.should == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          keep=2
          tags="$(gh release list --limit 100 --json tagName,createdAt -q 'sort_by(. , .createdAt) | reverse | .[].tagName')"
          i=0
          while IFS= read -r t; do
            [ -n "$t" ]||continue
            i="$((i+1))"
            if [ "$i" -le "$keep" ]; then continue; fi
            gh release delete "$t" -y --cleanup-tag || true
          done <<<"$tags"
